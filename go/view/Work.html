<!--
  ~ The MIT License (MIT)
  ~
  ~ Copyright (c) 2016.  Georg Beier. All rights reserved.
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in all
  ~ copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  ~ SOFTWARE.
  -->

{{define "work"}}
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DKFAI App</title>
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
    <!-- Optional Bootstrap theme -->
    <link rel="stylesheet" href="../css/bootstrap-theme.min.css">
    <script src="../js/jquery-3.1.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/validator.js"></script>
</head>
<body>
{{template "finder" .}}
{{template "fscript"}}
<hr>
{{template "tabs" . }}
</body>
</html>
{{end}}

{{define "finder"}}
<div style="margin: 5px">
    <nav role="navigation" class="navbar navbar-default">
            <a href="/logout" class="navbar-brand navbar-right">
                <span class="sr-only">Logout</span>
                <span class="glyphicon glyphicon-off" style="margin-right: 5 px"></span>
                &nbsp;
            </a>
            <div class="navbar-header">
                <button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div id="navbarCollapse" class="collapse navbar-collapse">
                <form role="search" class="navbar-form navbar-left">
                    {{template "csrf" . }}
                    <div class="form-group">
                        <input id="search1" type="text" placeholder="LastName" class="form-control" style="margin: 2px 0px;">
                        <input id="search2" type="text" placeholder="FirstName" class="form-control" style="margin: 2px 0px;">
                        <button id="find" type="button" class="btn btn-default" style="margin: 2px 0px;">
                            <span class="sr-only">Find</span>
                            <span class="glyphicon glyphicon-search"></span>
                        </button>
                        <div id="qapps" class="form-group" style="margin: 2px 0px;">
                            <select id="noresult" class="form-control" style="width: 16em;" disabled="disabled">
                                <option value="0">----------</option>
                            </select>
                        </div>
                    </div>
                </form>
        </div>
    </nav>
</div>
{{end}}

{{define "qresult"}}
<select id="sresult" class="form-control" style="width: 16em;" onchange="showSelect()">
    {{range .}}
    <option value="{{.id}}">{{.lastname}}, {{.firstname}}</option>
    {{else}}
    <option value="0">not found</option>
    {{end}}
</select>
{{end}}

{{define "tabs"}}
<script type="text/javascript">
    var searchStates = new Array();
    var finderValues = new Array();
</script>
<ul class="nav nav-tabs" id="workTabs">
    {{if .authenrol}}
    <script type="text/javascript">
        // objects that cache the search result select values of every tab
        searchStates['enrol'] = new SearchState('#qapps', '', '');
        searchStates['edit'] = new SearchState('#qapps', '', '');
        searchStates['cancellation'] = new SearchState('#qapps', '', '');
        // information to configure the search click url and result area of every tab
        finderValues['enrol'] = {findUrl: '/find/applicant', targetUrl: '/enrol/show', target: '#enrolarea'};
        finderValues['edit'] = {findUrl: '/find/applicant', targetUrl: '/enrol/show', target: '#editarea'};
        finderValues['cancellation'] = {findUrl: '/find/applicant', targetUrl: '/cancellation/show', target: '#cancellationarea'};


    </script>
    <li class="active" data-toggle="tooltip" data-placement="top" title="Enrol Candidates">
        <a data-toggle="tab" href="#enrol"><span class="glyphicon glyphicon-education"></span> </a>
    </li>
    <li data-toggle="tooltip" data-placement="top" title="Edit Candidate Data">
        <a data-toggle="tab" href="#edit"><span class="glyphicon glyphicon-pencil"></span></a>
    </li>
    <li data-toggle="tooltip" data-placement="top" title="Candidate Cancellation">
        <a data-toggle="tab" href="#cancellation"><span class="glyphicon glyphicon-remove-sign"></span></a>
    </li>
    {{end}}
    {{if .authpoff}}
    <script type="text/javascript">
        searchStates['results'] = new SearchState('#qapps', '', '');
        searchStates['resultlist'] = new SearchState('#qapps', '', '');
        finderValues['results'] = {findUrl: '/find/applicant', targetUrl: '/results/show', target: '#resultsarea'};
        finderValues['resultlist'] = {findUrl: '/find/applicant', targetUrl: '/enrol/resultlist', target: '#resultlistarea'};


    </script>
    <li data-toggle="tooltip" data-placement="top" title="Capture Test Results">
        <a data-toggle="tab" href="#results"><span class="glyphicon glyphicon-certificate"></span></a>
    </li>
    <li data-toggle="tooltip" data-placement="top" title="Results List">
        <a data-toggle="tab" href="#resultlist"><span class="glyphicon glyphicon-th-list"></span></a>
    </li>
    {{end}}
    {{if .authuadmin}}
    <script type="text/javascript">
        searchStates['users'] = new SearchState('#qapps', '', '');


    </script>
    <li data-toggle="tooltip" data-placement="top" title="Edit Users">
        <a data-toggle="tab" href="#users"><span class="glyphicon glyphicon-user"></span></a>
    </li>
    {{end}}
    <script type="text/javascript">
        searchStates['admin'] = new SearchState('#qapps', '', '');
        searchStates['trace'] = new SearchState('#qapps', '', '');


    </script>
    {{if .authfulladmin}}
    <li data-toggle="tooltip" data-placement="top" title="Administration">
        <a data-toggle="tab" href="#admin"><span class="glyphicon glyphicon-wrench"></span></a>
    </li>
    <li data-toggle="tooltip" data-placement="top" title="Trace Data Changes">
        <a data-toggle="tab" href="#trace"><span class="glyphicon glyphicon-eye-open"></span></a>
    </li>
    {{end}}
    {{if .authall}}
    <script type="text/javascript">
        searchStates['set'] = new SearchState('#qapps', '', '');


    </script>
    <li data-toggle="tooltip" data-placement="top" title="Profile Settings">
        <a data-toggle="tab" href="#set"><span class="glyphicon glyphicon-cog"></span></a>
    </li>
    {{end}}
</ul>
<div class="tab-content">
    {{if .authenrol}}
    <div id="enrol" class="tab-pane fade in active">
        <div id="enrolarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    <div id="edit" class="tab-pane fade">
        <div id="editarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    <div id="cancellation" class="tab-pane fade">
        <div class="radio-inline">
            <label for="do-cancellation" class="control-label">
                <input id="do-cancellation" type="radio" name="cancellation" value="" checked="checked">
                Exmatrikulieren
            </label>
        </div>
        <div class="radio-inline">
            <label for="undo-cancellation" class="control-label">
                <input id="undo-cancellation" type="radio" name="cancellation" value="undo">
                Exmatrikulation rückgängig machen
            </label>
        </div>
        <div id="cancellationarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    {{end}}
    {{if .authpoff}}
    <div id="results" class="tab-pane fade">
        <div id="resultsarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    <div id="resultlist" class="tab-pane fade">
        <div id="resultlistarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    {{end}}
    {{if .authuadmin}}
    <div id="users" class="tab-pane fade">
        <div id="usersarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    {{end}}
    {{if .authfulladmin}}
    <div id="admin" class="tab-pane fade">
        <div id="adminarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    <div id="trace" class="tab-pane fade">
        <div id="tracearea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    {{end}}
    {{if .authall}}
    <div id="selfadmin" class="tab-pane fade">
        <div id="selfadminarea" style="margin: 20px">
            <p></p>
        </div>
    </div>
    {{end}}
</div>
{{end}}

{{define "fscript"}}
<script type="text/javascript">
    var actTab = 'enrol';
    var prevTab = '';
    var searchFlag = '';
    var bounceProtect = '';
    $(document).ready(function(){
        // bind function to #find button:
        $("#find").click(defaultFind);
        // bind function to tab selection event
        $('a[data-toggle="tab"]').on('shown.bs.tab', tabSwitchHandler);
        $('#do-cancellation').click(true, onCancellationRadioClick);
        $('#undo-cancellation').click(false, onCancellationRadioClick);
    });

    // default finder function for find button clicks
    // send query fields to server and load response into div #qapps
    function defaultFind() {
        var search1 = $("input#search1").val()
        var search2 = $("input#search2").val()
        var csrfid = $("input#csrf_id_find").val()
        console.log("csrfid: " + csrfid);
        var findUrl;
        if(typeof(finderValues[actTab]) !== 'undefined') {
            findUrl = finderValues[actTab].findUrl;
            $("#qapps").load(findUrl, {lastname: search1, firstname: search2, csrf_token: csrfid,
                action: actTab, flag: actTab == 'cancellation' ? searchFlag : ''},
                showSelect);
        }
    }

    // handler for switch tab events
    function tabSwitchHandler(e) {
        actTab = (""+e.target).replace(/.*#/, "");
        prevTab = (""+e.relatedTarget).replace(/.*#/, "");
        if(bounceProtect != prevTab + actTab) {
            bounceProtect = prevTab + actTab;
            if('' != prevTab) {
                searchStates[prevTab].saveContent();
            }
            searchStates[actTab].restoreContent();
        }
    }

    // handler for switching exmatriculation radio buttons
    function onCancellationRadioClick(e) {
        var val = e.data;
        if(val) {
            searchFlag = '';
        } else {
            searchFlag = 'undo';
        }
        if(actTab == 'cancellation') {
            $('#find').click();
        }
    }


    // select the target area and service url for active tab and load from server
    function showSelect() {
        var selid = $('#sresult').val();
        var csrfid = $("input#csrf_id_find").val()
        if(typeof(finderValues[actTab]) !== 'undefined' && selid > 0) {
            var target = finderValues[actTab].target;
            var url = finderValues[actTab].targetUrl;
            $(target).load(url, {appid: selid, action: actTab, csrf_token: csrfid,
            flag: actTab == 'cancellation' ? searchFlag : ''});
        }
    }

    // constructor function for objects that save and recover search results html when tabs are changed
    function SearchState(fid, s1id, s2id) {
        var selectid = fid;
        var search1 = s1id;
        var search2 = s2id;
        var content =  $(selectid).html();
        var idx = -1;
        this.saveContent = function() {
            content = $(selectid).html();
            if($('#sresult').length) {
                idx = $('#sresult').val();
            }
        };
        this.restoreContent = function() {
            $(selectid).html(content);
            if($('#sresult').length) {
                $('#sresult').val(idx);
            }
        };
    }

    // post form data and check returned data. if it's not empty, edited object was
    // changed in the database. so normally update form fields and mark changes.
    // in case object was deleted, show alert and refresh find
    // if data is empty, call load area
    function postSubmissionAndReload(posturl, values, loadurl, area) {
        $.post(posturl, values, function( data ) {
            if( data ) {
                if (typeof data === 'string' || data instanceof String) {
                    alert(data);
                    //$("#find").click(defaultFind);
                    loadArea(loadurl, area);
                } else {
                    var keys = Object.keys(data);
                    keys.forEach(function(key) {
                        mergeVal(key, data[key], area);
                    });
                }
            } else {
                loadArea(loadurl, area);
            }
        });
    }

    // update fields with changed values and mark these fields
    function mergeVal( key, value, area ) {
        elements = Object.keys(value);
        // console.log("area: " + area + " key: " + key + " value: " + value['Other']);
        bg = ""
        setval = value['Other']
        /*
            NONE MergeDiffType = iota       // no changes at all
            MINE                            // only my value changed
            THEIRS                          // only their value changed
            BOTH                            // both values changed and are different
            SAME                            // both values changed but are equal
        */
        switch(value['Conflict']) {
            case 1:
                bg = "background-color: lightblue";
                setval = value['Mine']
                break;
            case 2:
                bg = "background-color: yellow";
                break;
            case 3:
                bg = "background-color: orangered";
                $(area + ' #' + key).prop('title', '[... ' + value['Mine'] + ' ?]')
                break;
            case 4:
                bg = "background-color: lightgreen";
                break;
        }
        $(area + ' #' + key + '-icon').attr('style', bg);
        $(area + ' #' + key).val(setval)
   }

    // load tab area with next from search field, removing previous fron search results.
    // clear area if no further results in search results list.
    function loadArea(url, area) {
        var sid = $('#sresult').val();
        var idx = $('#sresult').prop('selectedIndex');
        var csrfid = $("#csrf_id_find").val()
        $('option[value="'+sid+'"]').remove();
        var l = $('#sresult').children('option').length;
        // goto next in list
        if(l > idx) {
            $('#sresult').prop('selectedIndex', idx);
        // else goto prev or empty
        } else {
            $('#sresult').prop('selectedIndex', idx - 1);
        }
        if(l > 0) {
            var selid = $('#sresult').val();
            $(area).load(url, {appid: selid, csrf_token: csrfid, action: actTab});
        } else {
            $(area).html("");
        }
    }


</script>
{{end}}